#!/bin/bash
# lammps_batch_run.sh
# This script automates multiple runs of LAMMPS simulations with varying protein counts
# and saves only the trajectory files to a single directory.

# Ensure we have the required arguments
if (( $# != 6 )); then
    echo "Usage: lammps_batch_run.sh nsites sep n_min n_max n_runs traj_dir"
    exit 1
fi

nsites=$1     # Number of transcription units (TUs)
sep=$2        # Linear separation between TUs (in beads)
n_min=$3      # Minimum number of proteins (e.g., 10)
n_max=$4      # Maximum number of proteins (e.g., 100)
n_runs=$5     # Number of repetitions per protein count
traj_dir=$6   # Directory to store trajectory files

# Get the absolute path of the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Ensure trajectory directory exists (use absolute path)
traj_dir_abs="${SCRIPT_DIR}/$traj_dir"
mkdir -p "$traj_dir_abs"

# Loop over protein counts
for nprots in $(seq $n_min 10 $n_max); do
    run=1  # Initialize run counter
    runProt=1 # Initialise the run counter for in file
    echo "Generating input file for nprots=$nprots"
    
    # Call lammps_init.sh to generate input files for each configuration
    "$SCRIPT_DIR/lammps_init.sh" $nsites $sep $nprots $run "$traj_dir_abs"  # Pass absolute path for traj_dir
    
    # Determine the generated directory name (assuming consistent naming format)
    sim_dir=$(ls -d "$SCRIPT_DIR/testing/noise_Ns_${nsites}_l_${sep}_Np_${nprots}_run_${runProt}/" 2>/dev/null | head -n 1)
    if [[ -z "$sim_dir" ]]; then
        echo "Error: Simulation directory for nprots=$nprots was not found!"
        exit 1
    fi
    
    # Loop over the number of runs
    for (( i=0; i<n_runs; i++ )); do
        echo "Running simulation for nprots=$nprots, run=$run"
        
        # Build the run script path (absolute path)
        run_script="${sim_dir}/run_noise_Ns_${nsites}_l_${sep}_Np_${nprots}_run_${run}.sh"
        
        if [[ ! -f "$run_script" ]]; then
            echo "Error: Run script $run_script not found!"
            exit 1
        fi
        
        chmod +x "$run_script"  # Ensure the script is executable
        
        # Run the simulation and ensure it completes before moving forward
        echo "Running $run_script..."
        "$run_script"
        
        # Correctly look for the trajectory file based on the expected naming convention
        traj_file="${sim_dir}/pos-equil_noise_Ns_${nsites}_l_${sep}_Np_${nprots}_run_${run}.lammpstrj"
        
        if [[ ! -f "$traj_file" ]]; then
            echo "Error: Trajectory file $traj_file not found!"
            exit 1
        fi
        
        # Move trajectory file to the designated directory (absolute path)
        mv "$traj_file" "$traj_dir_abs/"
        
        ((run++))  # Increment run number
    done
    ((runProt++))
done

echo "All simulations completed. Trajectory files saved in $traj_dir_abs."
